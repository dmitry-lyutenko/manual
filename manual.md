# Prometheus

## Подключаем хосты

При установке Prometheus через плейбук (prometheus-node) inventory содержит следующий фрагмент:
```
# Host for monitoring with cadvisor
      cadvisor_targets:
        - 127.0.0.1:
          name:
            monitoring
        - 147.135.4.123:
          name:
            swarm-us-1
        - 217.182.166.215:
          name:
            swarm-eu-1
        - 176.9.107.98:
          name:
            swarm-eu-2
        - 173.249.26.11:
          name:
            swarm-reserve
```
Рассмотрим его подробнее.
 - ```cadvisor-target``` - указывает, что на указанных хостах мы будем собирать данные от cAdvisor.
 - описание хоста. Состоит из нескольких строк. Формат важен. Построчное описание выглядит так: 1 строка - IP-адрес хоста, который будет опрошен; 2 строка - ключевое слово name; 3 строка - имя хоста. Под этим, более удобным именем, хост будет виден в Prometheus или Grafana.
```
        - 147.135.4.123:
          name:
            swarm-us-1
```

# Grafana

## Создание DataSource

После залогинования в Grafana необходимо подключить Datasource. Из него она будет брать данные для отображения. Для этого идем в настройки и выбираем DataSources
![Image 01](img/01_menu_DS.png)
Получим следующую страницу:
![Image 02](img/02_add_datasource_green_button.png)
Здесь нужно нажать на ```Add data source```
Переходим на следующую страницу. Если на ней выставляем тип (Type) prometheus, Задаем произвольное имя (в данном случае Prometheus) и адрес подключения (http://127.0.0.1:9090). Образец на картинке ниже.
![Image 03](img/03_DS.png)
После чего нажимаем ```save & test```
Если получаем на зеленом фоне ```Data source is working```, то все в порядке и можно переходить к созданию Dashboard.

## Импорт Dashboard

Идем в настройки и выбирает Import
![Image 04](img/04_Import_select.png)

В поле, обозначенном, ```Grafana.com Dashboard``` вводим 893 и клацаем в произвольном месте. Графана сама подтянет из коллекции готовый dashboard. Получим следующий экран:
![Image 05](img/05_Import.png)

В выпадающем списке prometheus выберем Datasource, созданный на предыдущем этапе
![Image 06](img/06_Import.png)
И нажимаем ```Import```

Получим следующий dashboard
![Image 07](img/07_DB.png)

## Редактирование графиков

На скриншоте выше счетчик ```containers``` имеет явно завышенное значение. Исправим это. Для этого наведем курсор на заголовок. Справа появится индикатор выпадающего меню, нажмем на него и выберем ```Edit```. Как показано на следующем скриншоте

![Image 08](img/08_Edit_01.png)

После этого мы получим возможность изменить запрос для счетчика
![Image 09](img/09_Edit.png)
Сам запрос находится в строке, где стоит курсор
Изменим запрос, вместо ```name```, напишем ```exported_name```. Запрос примет вид ```count(rate(container_last_seen{exported_name=~".+"}[$interval]))```
Убрав фокус с поля ввода, увидим, как изменится значение на более актуальное. Нажав на ```back to dashboard``` (верхний правый угол, стрелка назад) вернемся снова к dashboard'у. Он примет вид:
![Image 10](img/10_dashboard.png)

## Добавление графиков.
В процессе работы может возникнуть необходимость знать как менялось количество контейнеров во времени. Это позволит увидеть, к примеру, что был перезапуск контейнера.
Начнем с того что, добавим к нашему стенду контейнеров. К примеру, выполнив в консоли машины с докером ```docker run --rm bash:latest ping 8.8.8.8&```
Таким образом мы получим 2 контейнера (контейнер с командой ```ping``` и контейнер с ```cAdvisor```). Теперь приступим к добавлению элемента dashboard'а.
Нажмем на ```Add panel``` (видно на скриншоте)
![Image 11](img/11_add.png)
Поскольку мы добавляем график, то его и выберем
![Image 12](img/12_add_graph.png)
У нас появится новая панель, с заголовком ```Panel Title```. Перейдем в режим редактирования. Теперь нам нужно указать источник данных (```Data source```). После чего появится поле для ввода запроса. Сам запрос можно взять из предыдущего примера. Он пойдет без изменений.
Теперь наш экран примет вид:
![Image 13](img/13_graph_all_01.png)
Переключимся на закладку ```General``` и укажем необходимое нам имя графика ```Containers count```
![Image 14](img/14_graph_all_01.png)
И выйдем из редактирования панели (стрелка вверху справа).
Теперь убьем ранее созданный контейнер с ping'ом. И подождем. Через некоторое время на графике отобразится изменение количества контейнеров.
![Image 15](img/15_containers_01.png)
А теперь для эксперимента запустим еще 2 контейнера с ping'ами. И понаблюдаем за изменением.
![Image 16](img/16_containers_02.png)
На скриншоте видно, как менялось во времени количество контейнеров.

Вернемся к режиму ипорта dashboard'а.
![Image 17](img/17_import_json.png)
В нем нажмем зеленую кнопку ```Import .json file``` и выберем для импорта файл demo.json, который прилагается к инструкции. После чего нажмем кнопку ```Import```. После чего мы увидим загруженный нами dashboard.
![Image 18](img/18_imported.png)

Отдельные его элементы были созданы в примерах выше. Остальные можно рассмотреть в качестве примеров.
